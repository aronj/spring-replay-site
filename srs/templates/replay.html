{% extends 'srs_base.html' %}
{% load comments %}
{% load cache %}

{% block replayheader %}    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/smoothness/jquery-ui-1.9.2.custom.min.css" />
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery-ui-1.9.2.custom.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/srs_replay.js"></script>

  {% if has_video %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/flowplayer_5.4.3.min.js"></script>
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/flowplayer_5.4.3_playful.css" />
  {% endif %}

<style>
.players {
     font: 11px Verdana,Arial,Helvetica,sans-serif;
     line-height: 14px;
}
.players a {
    color: inherit;
}
.players a:hover {
    color: #C3593C;
}
.bold {
     font-weight: bold;
}

  {% if has_video %}
.flowplayer { width: 80%; background-color: #222; background-size: cover; max-width: 800px; }
.flowplayer .fp-controls { background-color: rgba(0, 0, 0, 0.4)}
.flowplayer .fp-timeline { background-color: rgba(0, 0, 0, 0.5)}
.flowplayer .fp-progress { background-color: rgba(219, 0, 0, 1)}
.flowplayer .fp-buffer { background-color: rgba(249, 249, 249, 1)}
.flowplayer { background-image: url({{ STATIC_URL }}img/flvbackground.jpg)}
  {% endif %}
</style>
{% endblock %}

{% block pagetitle %}{{ replay.title }}{% endblock %}

{% block maincontent%}

<!-- REPLAY_BOX -->

        <div class="left" itemscope itemtype="http://schema.org/PlayAction">
            <meta itemprop="url" content="{{ replay.get_absolute_url }}"/>
            <div itemprop="audience" itemscope itemtype="http://schema.org/Audience">
                <meta itemprop="name" content="gamers">
                <meta itemprop="url" content="http://springrts.com/">
                <meta itemprop="sameAs" content="http://en.wikipedia.org/wiki/Spring_(game_engine)">
            </div>
            <div class="lt"></div>
            <div class="lbox" style="height:200px;">
                <p itemprop="name" style="font-size: larger; font-weight: bold;">{{ replay.title }}</p>
{% include "replay_box.html" %}
            </div>

<!-- MAP IMG -->

        <div class="left" style="width: 350px;">
            {% if upload_broken %}<p style="text-align:center; color:red; font-weight:bold;">ERROR while reading replays file. Please reupload, preferably a replay file of another player. If problem persists, please contact Dansan at the <a href="http://springrts.com/phpbb/ucp.php?i=pm&mode=compose&u=9838">forums</a>.</p>{% endif %}
            {% if user = replay.uploader %}<p style="text-align:center; color:red; font-weight:bold;">&raquo;&raquo;&raquo;&nbsp;&nbsp;<a href="{% url srs.views.edit_replay replay.gameID %}">Edit text / tags</a>&nbsp;&nbsp;&laquo;&laquo;&laquo;</p>{% endif %}
            {% if user.is_staff %}<a href="/admin/srs/replay/{{ replay.pk }}/">replay @admin site</a>{% endif %}
{% cache 600 replay replay.pk %}
            <p class="clickme_winner" style="color: #4A8EBC; text-align: center; font-weight:bold;">&raquo;&raquo;&raquo;&nbsp;&nbsp;Click me to show winner and rating changes.&nbsp;&nbsp;&laquo;&laquo;&laquo;</p>
	        <img itemprop="image" src="{{ replay.map_img.get_absolute_url }}" alt="pic of map {{ replay.map_info.name }}" width="340"/>
	        <p><br/></p>
            <div class="footer"></div>

<!-- UPLOAD COMMENT -->

            <p><b>Uploaders comment:</b> {{ replay.long_text }}</p>
            <p><br/></p>
	        <div class="footer"></div>

<!-- MAP / MOD OPTIONS -->

	        <p class="clickme_mapoptions" style="color: #4A8EBC; text-align: center; font-weight:bold;">Map options (click me)</p>
	        <div class="blind_mapoptions" style="display:none;">
		        {% if mapoptions|length > 0 %}
		        <div class="left" style="width: 175px;">
		           {% for option in mapoptions|slice:"::2" %}
			       <p>{{option.name }}: {{ option.value }}</p>
			       {% endfor %}
			    </div>
			    <div class="left" style="width: 175px;">
	               {% for option in mapoptions|slice:"1::2" %}
	               <p>{{option.name }}: {{ option.value }}</p>
	               {% endfor %}
	            </div>
		       {% else %}
			       <p>None.</p>
		       {% endif %}
	       </div>
           <p class="clickme_modoptions" style="color: #4A8EBC; text-align: center; font-weight:bold;">Mod options (click me)</p>
           <div class="blind_modoptions" style="display:none;">
	           {% if modoptions|length > 0 %}
	           <div class="left" style="width: 175px;">
	                {% for option in modoptions|slice:"::2" %}
	                <p>{{option.name }}: {{ option.value }}</p>
	                {% endfor %}
	           </div>
	           <div class="left" style="width: 175px;">
	                {% for option in modoptions|slice:"1::2" %}
	                <p>{{option.name }}: {{ option.value }}</p>
	                {% endfor %}
	           </div>
	           {% else %}
	                <p>None.</p>
	           {% endif %}
           </div>
           <div class="footer"></div>
	    </div>

<!-- RATING -->

	    <div class="left players" style="width: 240px; padding: 0;">
	        {% if replay.notcomplete %}<p style="color:maroon;"><b><span itemprop="result">Replay is incomplete or length of match less than 2 minutes. Not rated.</span></b></p>{% endif %}
            {% if is_draw %}<div class="blind_winner" style="display:none; color:maroon; font-weight:bold"><span itemprop="result">The match was a draw!</span></div>{% endif %}
            {% if was_stopped %}<div class="blind_winner" style="display:none; color:maroon; font-weight:bold"><span itemprop="result">The match was stopped!</span></div>{% endif %}
	        <table border="0" cellpadding="0" cellspacing="0" rules="none" width="240px">
                <colgroup>
                    <col />
                    <col />
                    <col />
                    <col />
                    <col />
                    <col />
                </colgroup>
{% if not user.is_authenticated or logged_in_pa and logged_in_pa.sldb_privacy_mode != 0 %}
                <tr class="body">
                    <td colspan="6">Want to see <b>exact TrueSkill</b> values?</td>
                </tr>
                <tr class="body">
                    <td colspan="6">* <u><a href="{% url srs.views.login %}?next={{ selfurl }}">Log in</a></u> to see yours.</td>
                </tr>
                <tr class="body">
                    <td colspan="6">* To let others see your TrueSkill, <u><a href="{% url srs.views.sldb_privacy_mode %}">click to change your privacy setting</a></u>.</td>
                </tr>
                <tr class="body">
                    <td colspan="6">* To see other players exact skills, tell them to do so too.</td>
                </tr>
                <tr class="body">
                    <td colspan="6"><br/></td>
                </tr>
{% endif %}
                <tr class="body">
                    <td colspan="6" style="text-align:right;">{% if not has_bot %}TrueSkill &nbsp;{% endif %}[Rank]</td>
                </tr>
{% for at, players, old_rating, new_rating, lobby_rank_sum in allyteams %}
                <tr class="body bold">
                    <td style="padding-bottom:5px"><b>Team {{ at.num }}</b>{% if at.winner %}<div class="blind_winner" style="display:none;"><img alt="Winner" src="{{ STATIC_URL }}img/trophy_32.png"/></div>{% endif %}</td>
                    <td></td>
  {% if not has_bot %}
    {% if replay.match_type_short == "T" or replay.match_type_short == "G" %}
                    <td style="text-align:right;">{{ old_rating|floatformat:1 }}</td>
                    <td style="text-align:center;"><div class="blind_winner" style="display:none;">&rarr;</div></td>
                    <td style="text-align:right;"><div class="blind_winner" style="display:none;">{{ new_rating|floatformat:1 }}</div></td>
                    <td style="text-align:right;">&nbsp;[{{ lobby_rank_sum }}]</td>
    {% else %}
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
    {% endif %}
  {% else %}
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
  {% endif %}

	            </tr>
    {% for p, pl_old, pl_new in players %}
                <tr class="body linehl bold" style="color: #{{ p.team.rgbcolor }};">
                    <td itemprop="agent" itemscope itemtype="http://schema.org/Person">{% if p.account.accountid != 0 %}{{ p.team.num }} <a href="{{ p.get_absolute_url }}" itemprop="url"><span itemprop="name">{{ p.name }}</span></a>{% else %}<span itemprop="name">{{ p.name }}</span>{% endif %}{% if is_draw %}<link itemprop="additionalType" href="http://schema.org/TieAction"/>{% else %}{% if at.winner %}<link itemprop="additionalType" href="http://schema.org/WinAction"/>{% else %}<link itemprop="additionalType" href="http://schema.org/LoseAction"/>{% endif %}{% endif %}</td>
                    <td style="">{{ p.team.side|ljust:"4" }}</td>
      {% if has_bot %}
                    <td></td>
                    <td></td>
                    <td></td>
      {% else %}
                    <td style="text-align:right;">&nbsp;{{ pl_old }}</td>
                    <td style="text-align:center;"><div class="blind_winner" style="display:none;">&rarr;</div></td>
                    <td style="text-align:right;"><div class="blind_winner" style="display:none;">{{ pl_new }}</div></td>
      {% endif %}
                    <td class="body linehl" style="text-align:right;" >&nbsp;[{{ p.rank }}]</td>
                </tr>
    {% endfor %}
                <tr>
                    <td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td>
                </tr>
{% endfor %}
	            <tr>
		            <td class="body" style="padding-bottom:5px"><b>Spectators</b></td>
	                <td></td><td></td><td></td><td></td><td></td>
                </tr>
<!-- SPECS -->
	{% if specs|length > 0 %}
        {% for s in specs %}
                <tr>
	                <td class="body" itemprop="participant" itemscope itemtype="http://schema.org/Person"><span itemprop="name">{{ s.name }}</span><meta itemprop="url" content="{{ s.get_absolute_url }}"><link itemprop="additionalType" content="http://schema.org/WatchAction"/></td>
	                <td></td><td></td><td></td><td></td><td></td>
	            </tr>
        {% endfor %}
	{% else %}
                <tr>
                    <td class="body">None.</td>
                    <td></td><td></td><td></td><td></td><td></td>
                </tr>
    {% endif %}
	        </table>
	   </div>
{% endcache %}

<!-- EXTRA MEDIA -->

       <div class="left" style="width: 580px; padding: 0;">
  {% if user in replay_owners %}
            <p style="text-align:center; color:red; font-weight:bold;">&raquo;&raquo;&raquo;&nbsp;&nbsp;<a href="{% url srs.upload.upload_media replay.gameID %}">Upload media files.</a>&nbsp;&nbsp;&laquo;&laquo;&laquo;</p>
            <div class="footer"></div>
  {% endif %}
  {% if extra_media %}
    {% for media in extra_media %}
          <div itemscope itemtype="http://schema.org/MediaObject">
      {% if media.image %}
            <p><b><span itemprop="name">{{ media.image_basename }}</span></b> (Click to open picture maximized.)</p>
            <p><a href="{{ media.image.url }}" title="Click to open picture maximized." itemprop="image"><img src="{{ media.image.url }}" alt="User-supplied image." style="max-width:100%; max-height:250px;" itemprop="thumbnailUrl"/></a></p>
      {% endif %}
      {% if media.media %}
            <p><b><span itemprop="name">{{ media.media_basename }}</span>:</b> {{ media.media_magic_text }} (<span itemprop="encodingFormat">{{ media.media_magic_mime }}</span>)</p>
        {% if media.media_magic_mime in known_video_formats %}
            <div data-swf="{{ STATIC_URL }}flowplayer_5.4.3.swf" class="flowplayer" itemprop="video" itemscope itemtype="http://schema.org/VideoObject">
                <video>
                    <source type="{{ media.media_magic_mime }}" src="{{ media.media.url }}" itemprop="contentUrl" content="{{ media.media.url }}"/>
                </video>
            </div>
        {% else %}
            <span itemprop="video" itemscope itemtype="http://schema.org/VideoObject">
                <p style="font-weight:bold"><a href="{% url srs.views.media media.id %}" target="_blank"  itemprop="contentUrl" content="{% url srs.views.media media.id %}">Click to open "{{ media.media_basename }}" in a new window.</a></p>
            </span>
        {% endif %}
      {% endif %}
            <p><b>Comment: </b><span itemprop="about">{{ media.comment }}</span></p>
            <p><b>Uploaded by</b> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">{{ media.uploader }}</span></span> on <span itemprop="uploadDate" content="{{ media.upload_date.isoformat }}">{{ media.upload_date }}</span></p>
            <div class="footer"></div>
          </div>
    {% endfor %}
  {% endif %}
       </div>

<!-- COMMENTS -->

	   <div class="left" itemscope itemtype="http://schema.org/WebPage">
            {% get_comment_count for replay as comment_count %}
	        <h3>Comments ({{ comment_count }}):</h3>
	        {% get_comment_list for replay as comment_list %}
			{% for comment in comment_list %}
            <span itemprop="comment" itemscope itemtype="http://schema.org/UserComments">
				<p><a name="c{{ comment.id }}"></a>
				<b>Comment by "<span itemprop="creator" itemscope itemtype="http://schema.org/Person"><span itemprop="name">{{ comment.user.username }}</span></span>" on <span itemprop="commentTime" content="{{ comment.submit_date.isoformat }}">{{ comment.submit_date }}</span></b> <a href="{% get_comment_permalink comment %}" itemprop="url">(link)</a>: <span itemprop="commentText">{{ comment.comment }}</span></p>
            </span>
			{% endfor %}
	        <a name="afterlastcomment"></a>

            <div class="footer"></div>
	        {% if user.is_authenticated %}
            <h3>Post a comment:</h3>
{% render_comment_form for replay %}
			{% else %}
			<h3>To post a comment you have to <a href="{% url srs.views.login %}?next={{ selfurl }}">log in</a>.</h3>
            {% endif %}
        </div>
        </div>
{% endblock %}
