{% extends 'srs_base.html' %}
{% load render_table from django_tables2 %}
{% load comments %}
{% load cache %}

{% block listheader %}    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}django_tables2/themes/paleblue/css/screen.css" />{% endblock %}
{% block replayheader %}    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/smoothness/jquery-ui-1.9.2.custom.min.css" />
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery-ui-1.9.2.custom.min.js"></script>

  {% if has_video %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/flowplayer_5.4.3.min.js"></script>
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/flowplayer_5.4.3_playful.css" />
  {% endif %}

<script type="text/javascript">
  $(document).ready(function() {
    $(".clickme_winner").click(function () {
      $(".blind_winner").show("blind", {}, 1000);
    });
  });
  $(document).ready(function() {
	  $(".clickme_mapoptions").click(function () {
		  $(".blind_mapoptions").show("blind", {}, 1000);
		  });
	  });
  $(document).ready(function() {
      $(".clickme_modoptions").click(function () {
          $(".blind_modoptions").show("blind", {}, 1000);
          });
      });
	$(document).ready(function() {
		$('tr.linehl').hover(function() {
			$(this).css("background-color", "rgb(224, 224, 224)");
		}, function() {
			$(this).css("background-color", "inherit");
		});
	});
</script>
<style>
.players a {
    color: inherit;
}
.players a:hover {
    color: #C3593C;
}
  {% if has_video %}
 .flowplayer { width: 80%; background-color: #222; background-size: cover; max-width: 800px; }
 .flowplayer .fp-controls { background-color: rgba(0, 0, 0, 0.4)}
 .flowplayer .fp-timeline { background-color: rgba(0, 0, 0, 0.5)}
 .flowplayer .fp-progress { background-color: rgba(219, 0, 0, 1)}
 .flowplayer .fp-buffer { background-color: rgba(249, 249, 249, 1)}
 .flowplayer { background-image: url({{ STATIC_URL }}img/flvbackground.jpg)}
  {% endif %}
</style>
{% endblock %}

{% block pagetitle %}{{ replay.title }}{% endblock %}

{% block maincontent%}

<!-- REPLAY_BOX -->

        <div class="left">
            <div class="lt"></div>
            <div class="lbox" style="height:200px;">
                <p><big><b>{{ replay.title }}</b></big></p>
{% include "replay_box.html" %}
            </div>

<!-- MAP IMG -->

        <div class="left" style="width: 350px;">
            {% if upload_broken %}<p style="text-align:center; color:red; font-weight:bold;">ERROR while reading replays file. Please reupload, preferably a replay file of another player. If problem persists, please contact Dansan at the <a href="http://springrts.com/phpbb/ucp.php?i=pm&mode=compose&u=9838">forums</a>.</p>{% endif %}
            {% if user = replay.uploader %}<p style="text-align:center; color:red; font-weight:bold;">&raquo;&raquo;&raquo;&nbsp;&nbsp;<a href="{% url srs.views.edit_replay replay.gameID %}">Edit text / tags</a>&nbsp;&nbsp;&laquo;&laquo;&laquo;</p>{% endif %}
            {% if user.is_staff %}<a href="/admin/srs/replay/{{ replay.pk }}/">replay @admin site</a>{% endif %}
{% cache 600 replay replay.pk %}
            <p class="clickme_winner" style="color: #4A8EBC; text-align: center; font-weight:bold;">&raquo;&raquo;&raquo;&nbsp;&nbsp;Click me to show winner and rating changes.&nbsp;&nbsp;&laquo;&laquo;&laquo;</p>
	        <img src="{{ replay.map_img.get_absolute_url }}" alt="pic of map {{ replay.map_info.name }}" width="340"/>
	        <p><br/></p>
            <div class="footer"></div>

<!-- UPLOAD COMMENT -->

            <p><b>Uploaders comment:</b> {{ replay.long_text }}</p>
            <p><br/></p>
	        <div class="footer"></div>

<!-- MAP / MOD OPTIONS -->

	        <p class="clickme_mapoptions" style="color: #4A8EBC; text-align: center; font-weight:bold;">Map options (click me)</p>
	        <div class="blind_mapoptions" style="display:none;">
		        {% if mapoptions|length > 0 %}
		        <div class="left" style="width: 175px;">
		           {% for option in mapoptions|slice:"::2" %}
			       <p>{{option.name }}: {{ option.value }}</p>
			       {% endfor %}
			    </div>
			    <div class="left" style="width: 175px;">
	               {% for option in mapoptions|slice:"1::2" %}
	               <p>{{option.name }}: {{ option.value }}</p>
	               {% endfor %}
	            </div>
		       {% else %}
			       <p>None.</p>
		       {% endif %}
	       </div>
           <p class="clickme_modoptions" style="color: #4A8EBC; text-align: center; font-weight:bold;">Mod options (click me)</p>
           <div class="blind_modoptions" style="display:none;">
	           {% if modoptions|length > 0 %}
	           <div class="left" style="width: 175px;">
	                {% for option in modoptions|slice:"::2" %}
	                <p>{{option.name }}: {{ option.value }}</p>
	                {% endfor %}
	           </div>
	           <div class="left" style="width: 175px;">
	                {% for option in modoptions|slice:"1::2" %}
	                <p>{{option.name }}: {{ option.value }}</p>
	                {% endfor %}
	           </div>
	           {% else %}
	                <p>None.</p>
	           {% endif %}
           </div>
           <div class="footer"></div>
	    </div>

<!-- RATING -->

	    <div class="left players" style="width: 240px; padding: 0;">
	        {% if replay.notcomplete %}<p style="color:maroon;"><b>Replay is incomplete or length of match less than 2 minutes. Not rated.</b></p>{% endif %}
            {% if is_draw %}<div class="blind_winner" style="display:none; color:maroon; font-weight:bold">The match was a draw!</div>{% endif %}
            {% if was_stopped %}<div class="blind_winner" style="display:none; color:maroon; font-weight:bold">The match was stopped!</div>{% endif %}
            <p class="body" style="font: 11px Arial,Helvetica,sans-serif; line-height: 14px; text-align:right;">{% if replay.match_type_short == "T" or replay.match_type_short == "G" %}TrueSkill{% else %}Elo{% endif %} &nbsp;[Rank]</p>
	        <table border="0" cellpadding="0" cellspacing="0" rules="none" width="240px">
                <colgroup>
                    <col />
                    <col />
                    <col />
                    <col />
                    <col />
                    <col />
                </colgroup>
{% if not user.is_authenticated or logged_in_pa and logged_in_pa.sldb_privacy_mode != 0 %}
                <tr class="body" style="font: 11px Arial,Helvetica,sans-serif; line-height: 14px;">
                    <td colspan="6">Want to see <b>exact TrueSkill</b> values?</td>
                </tr>
                <tr class="body" style="font: 11px Arial,Helvetica,sans-serif; line-height: 14px;">
                    <td colspan="6">* <u><a href="{% url srs.views.login %}">Log in</a></u> to see yours.</td>
                </tr>
                <tr class="body" style="font: 11px Arial,Helvetica,sans-serif; line-height: 14px;">
                    <td colspan="6">* To let others see your TrueSkill, type into lobby chat: <pre>/msg SLDB !set privacyMode 0</pre></td>
                </tr>
                <tr class="body" style="font: 11px Arial,Helvetica,sans-serif; line-height: 14px;">
                    <td colspan="6">* To see other players exact skills, tell them to do so too.</td>
                </tr>
                <tr class="body" style="font: 11px Arial,Helvetica,sans-serif; line-height: 14px;">
                    <td colspan="6"><br/></td>
                </tr>
                <tr class="body" style="font: 11px Arial,Helvetica,sans-serif; line-height: 14px;">
                    <td colspan="6"><br/></td>
                </tr>
{% endif %}
{% for at, players, old_rating, new_rating, lobby_rank_sum in allyteams %}
                <tr class="body" style="font: 11px Arial,Helvetica,sans-serif; line-height: 14px;">
                    <td style="padding-bottom:5px"><b>Team {{ forloop.counter }}</b>{% if at.winner %}<div class="blind_winner" style="display:none;"><img alt="Winner" src="{{ STATIC_URL }}img/trophy_32.png"/></div>{% endif %}</td>
                    <td></td>
    {% if replay.match_type_short == "T" or replay.match_type_short == "G" %}{% if old_rating != 0 and new_rating != 0 %}
                    <td style="text-align:right;">{{ old_rating|floatformat:1 }}</td>
                    <td style="text-align:center;"><div class="blind_winner" style="display:none;">&rarr;</div></td>
                    <td style="text-align:right;"><div class="blind_winner" style="display:none;">{{ new_rating|floatformat:1 }}</div></td>
                    <td style="text-align:right;">&nbsp;[{{ lobby_rank_sum }}]</td>
    {% else %}
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
    {% endif %}{% endif %}
	            </tr>
    {% for p, pl_old, pl_new in players %}
                <tr class="body linehl" style="font: 11px Arial,Helvetica,sans-serif; line-height: 14px; color: #{{ p.team.rgbcolor }};">
                    <td>{% if p.account.accountid != 0 %}<a href="{{ p.get_absolute_url }}">{{ p.name }}</a>{% else %}{{ p.name }}{% endif %}</td>
                    <td style="">{{ p.team.side|ljust:"4" }}</td>

                    <td style="text-align:right;">&nbsp;{{ pl_old }}</td>
                    <td style="text-align:center;"><div class="blind_winner" style="display:none;">&rarr;</div></td>
                    <td style="text-align:right;"><div class="blind_winner" style="display:none;">{{ pl_new }}</div></td>

                    <td class="body linehl" style="font: 11px Arial,Helvetica,sans-serif; line-height: 14px; text-align:right;" >&nbsp;[{{ p.rank }}]</td>
                </tr>
    {% endfor %}
                <tr>
                    <td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td>
                </tr>
{% endfor %}
	            <tr>
		            <td class="body" style="font: 11px Arial,Helvetica,sans-serif; line-height: 14px; padding-bottom:5px"><b>Spectators</b></td>
	                <td></td><td></td><td></td><td></td><td></td>
                </tr>
	{% if specs|length > 0 %}
        {% for s in specs %}
                <tr>
	                <td class="body" style="font: 11px Arial,Helvetica,sans-serif; line-height: 14px;">{{ s.name }}</td>
	                <td></td><td></td><td></td><td></td><td></td>
	            </tr>
        {% endfor %}
	{% else %}
                <tr>
                    <td class="body" style="font: 11px Arial,Helvetica,sans-serif; line-height: 14px;">None.</td>
                    <td></td><td></td><td></td><td></td><td></td>
                </tr>
    {% endif %}
	        </table>
	   </div>
{% endcache %}

<!-- EXTRA MEDIA -->

       <div class="left" style="width: 580px; padding: 0;">
  {% if user in replay_owners %}
            <p style="text-align:center; color:red; font-weight:bold;">&raquo;&raquo;&raquo;&nbsp;&nbsp;<a href="{% url srs.upload.upload_media replay.gameID %}">Upload media files.</a>&nbsp;&nbsp;&laquo;&laquo;&laquo;</p>
            <div class="footer"></div>
  {% endif %}
  {% if extra_media %}
    {% for media in extra_media %}

      {% if media.image %}
            <p><b>{{ media.image_basename }}</b> (Click to open picture maximized.)</p>
            <p><a href="{{ media.image.url }}" title="Click to open picture maximized."><img src="{{ media.image.url }}" alt="User-supplied image." style="max-width:100%; max-height:250px;"/></a></p>
      {% endif %}
      {% if media.media %}
            <p><b>{{ media.media_basename }}:</b> {{ media.media_magic_text }} ({{ media.media_magic_mime }})</p>
        {% if media.media_magic_mime in known_video_formats %}
            <div data-swf="{{ STATIC_URL }}flowplayer_5.4.3.swf" class="flowplayer">
                <video>
                    <source type="{{ media.media_magic_mime }}" src="{{ media.media.url }}"/>
                </video>
            </div>
        {% else %}
            <p style="font-weight:bold"><a href="{% url srs.views.media media.id %}" target="_blank">Click to open "{{ media.media_basename }}" in a new window.</a></p>
        {% endif %}
      {% endif %}
            <p><b>Comment: </b>{{ media.comment }}</p>
            <p><b>Uploaded by</b> {{ media.uploader }} on {{ media.upload_date }}</p>
            <div class="footer"></div>
    {% endfor %}
  {% endif %}
       </div>

<!-- COMMENTS -->

	   <div class="left">
            {% get_comment_count for replay as comment_count %}
	        <h3>Comments ({{ comment_count }}):</h3>
	        {% get_comment_list for replay as comment_list %}
			{% for comment in comment_list %}
				<p><a name="c{{ comment.id }}"></a>
				<b>Comment by "{{ comment.user.username }}" on {{ comment.submit_date }}</b> <a href="{% get_comment_permalink comment %}">(link)</a>: {{ comment.comment }}</p>
			{% endfor %}
	        <a name="afterlastcomment"></a>

            <div class="footer"></div>
	        {% if user.is_authenticated %}
            <h3>Post a comment:</h3>
{% render_comment_form for replay %}
			{% else %}
			<h3>To post a comment you have to <a href="{% url srs.views.login %}">log in</a>.</h3>
            {% endif %}
        </div>
        </div>
{% endblock %}
