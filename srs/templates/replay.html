{% extends 'srs_base.html' %}
{% load render_table from django_tables2 %}
{% load comments %}
{% load cache %}

{% block listheader %}    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}django_tables2/themes/paleblue/css/screen.css" />{% endblock %}
{% block replayheader %}    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/smoothness/jquery-ui-1.9.2.custom.min.css" />
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery-ui-1.9.2.custom.min.js"></script>

<script type="text/javascript">
  $(document).ready(function() {
    $(".clickme_winner").click(function () {
      $(".blind_winner").show("blind", {}, 1000);
    });
  });
  $(document).ready(function() {
	  $(".clickme_mapoptions").click(function () {
		  $(".blind_mapoptions").show("blind", {}, 1000);
		  });
	  });
  $(document).ready(function() {
      $(".clickme_modoptions").click(function () {
          $(".blind_modoptions").show("blind", {}, 1000);
          });
      });
</script>
{% endblock %}

{% block pagetitle %}{{ replay.title }}{% endblock %}

{% block maincontent%}
        <div class="left">
            <div class="lt"></div>
            <div class="lbox" style="height:200px;">
                <p><big><b>{{ replay.title }}</b></big></p>
{% include "replay_box.html" %}
            </div>
        <div class="left" style="width: 350px;">
            {% if upload_broken %}<p style="text-align:center; color:red; font-weight:bold;">ERROR while reading replays file. Please reupload, preferably a replay file of another player. If problem persists, please contact Dansan at the <a href="http://springrts.com/phpbb/ucp.php?i=pm&mode=compose&u=9838">forums</a>.</p>{% endif %}
            {% if user = replay.uploader %}<p style="text-align:center; color:red; font-weight:bold;">&raquo;&raquo;&raquo;&nbsp;&nbsp;<a href="{% url srs.views.edit_replay replay.gameID %}">Edit text / tags</a>&nbsp;&nbsp;&laquo;&laquo;&laquo;</p>{% endif %}
            {% if user.is_staff %}<a href="/admin/srs/replay/{{ replay.pk }}/">replay @admin site</a>{% endif %}
{% cache 600 replay replay.pk %}
            <p class="clickme_winner" style="color: #4A8EBC; text-align: center; font-weight:bold;">&raquo;&raquo;&raquo;&nbsp;&nbsp;Click me to show winner and rating changes.&nbsp;&nbsp;&laquo;&laquo;&laquo;</p>
	        <img src="{{ replay.map_img.get_absolute_url }}" alt="pic of map {{ replay.map_info.name }}" width="340"/>
	        <p><br/></p>
	        <div class="footer"></div>
	        <p class="clickme_mapoptions" style="color: #4A8EBC; text-align: center; font-weight:bold;">Map options (click me)</p>
	        <div class="blind_mapoptions" style="display:none;">
		        {% if mapoptions|length > 0 %}
		        <div class="left" style="width: 175px;">
		           {% for option in mapoptions|slice:"::2" %}
			       <p>{{option.name }}: {{ option.value }}</p>
			       {% endfor %}
			    </div>
			    <div class="left" style="width: 175px;">
	               {% for option in mapoptions|slice:"1::2" %}
	               <p>{{option.name }}: {{ option.value }}</p>
	               {% endfor %}
	            </div>
		       {% else %}
			       <p>None.</p>
		       {% endif %}
	       </div>
	       <div class="footer"></div>
           <p class="clickme_modoptions" style="color: #4A8EBC; text-align: center; font-weight:bold;">Mod options (click me)</p>
           <div class="blind_modoptions" style="display:none;">
	           {% if modoptions|length > 0 %}
	           <div class="left" style="width: 175px;">
	                {% for option in modoptions|slice:"::2" %}
	                <p>{{option.name }}: {{ option.value }}</p>
	                {% endfor %}
	           </div>
	           <div class="left" style="width: 175px;">
	                {% for option in modoptions|slice:"1::2" %}
	                <p>{{option.name }}: {{ option.value }}</p>
	                {% endfor %}
	           </div>
	           {% else %}
	                <p>None.</p>
	           {% endif %}
           </div>
           <div class="footer"></div>
           <h3>Players ratings after this match</h3>
           {% if table.data|length == 0 %}
            <p style="font-weight:bold;"><br/>This match has not been rated (yet).</p>
			{% else %}
			{% render_table table %}
			{% endif %}
			<p><br/></p>
           <div class="footer"></div>
	       <p><b>Uploaders comment:</b> {{ replay.long_text }}</p>
	       <p><br/></p>
	    </div>
	    <div class="left" style="width: 240px; padding: 0;">
	        {% if replay.notcomplete %}<p style="color:maroon;"><b>Replay is incomplete or length of match less than 2 minutes. Not rated.</b></p>{% endif %}
            {% if is_draw %}<div class="blind_winner" style="display:none; color:maroon; font-weight:bold">The match was a draw!</div>{% endif %}
            <p style="class:body; font: 11px Arial,Helvetica,sans-serif; line-height: 14px; text-align:right;">{% if replay.match_type_short == "T" or replay.match_type_short == "G" %}TrueSkill{% else %}Elo{% endif %} &nbsp;[Rank]</p>
	        <table border="0" cellpadding="0" cellspacing="0" rules="none" width="240px">
                <colgroup>
                    <col />
                    <col />
                    <col />
                    <col />
                    <col />
                    <col />
                </colgroup>
{% for at, players, old_rating, new_rating, lobby_rank_sum in allyteams %}
                <tr>
                    <td style="class:body; font: 11px Arial,Helvetica,sans-serif; line-height: 14px; padding-bottom:5px"><b>Team {{ forloop.counter }}</b>{% if at.winner %}<div class="blind_winner" style="display:none;"><img alt="Winner" src="{{ STATIC_URL }}img/trophy_32.png"/></div>{% endif %}</td>
                    <td></td>
    {% if replay.match_type_short == "T" or replay.match_type_short == "G" %}{% if old_rating != 0 and new_rating != 0 %}
                    <td style="class:body; font: 11px Arial,Helvetica,sans-serif; line-height: 14px; text-align:right;">{{ old_rating|floatformat:1 }}</td>
                    <td style="class:body; font: 11px Arial,Helvetica,sans-serif; line-height: 14px; text-align:center;"><div class="blind_winner" style="display:none;">&rarr;</div></td>
                    <td style="class:body; font: 11px Arial,Helvetica,sans-serif; line-height: 14px; text-align:right;"><div class="blind_winner" style="display:none;">{{ new_rating|floatformat:1 }}</div></td>
                    <td style="class:body; font: 11px Arial,Helvetica,sans-serif; line-height: 14px; text-align:right;">&nbsp;[{{ lobby_rank_sum }}]</td>
    {% else %}
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
    {% endif %}{% endif %}
	            </tr>
    {% for p, pl_old, pl_new in players %}
                <tr>
                    <td style="class:body; font: 11px Arial,Helvetica,sans-serif; line-height: 14px; color:#{{ t.rgbcolor }}">{% if p.account.accountid != 0 %}<a href="{{ p.get_absolute_url }}">{{ p.name }}</a>{% else %}{{ p.name }}{% endif %}</td>
                    <td style="class:body; font: 11px Arial,Helvetica,sans-serif; line-height: 14px;">{{ p.team.side|ljust:"4" }}</td>
        {% if pl_old != 0 and pl_new != 0 %}
                    <td style="class:body; font: 11px Arial,Helvetica,sans-serif; line-height: 14px; text-align:right;">&nbsp;{{ pl_old|floatformat:1 }}</td>
                    <td style="class:body; font: 11px Arial,Helvetica,sans-serif; line-height: 14px; text-align:center;"><div class="blind_winner" style="display:none;">&rarr;</div></td>
                    <td style="class:body; font: 11px Arial,Helvetica,sans-serif; line-height: 14px; text-align:right;"><div class="blind_winner" style="display:none;">{{ pl_new|floatformat:1 }}</div></td>
        {% else %}
                    <td></td>
                    <td></td>
                    <td></td>
        {% endif %}
                    <td style="class:body; font: 11px Arial,Helvetica,sans-serif; line-height: 14px; text-align:right;" >&nbsp;[{{ p.rank }}]</td>
                </tr>
    {% endfor %}
                <tr>
                    <td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td>
                </tr>
{% endfor %}
	            <tr>
		            <td style="class:body; font: 11px Arial,Helvetica,sans-serif; line-height: 14px; padding-bottom:5px"><b>Spectators</b></td>
	                <td></td><td></td><td></td><td></td><td></td>
                </tr>
	{% if specs|length > 0 %}
        {% for s in specs %}
                <tr>
	                <td style="class:body; font: 11px Arial,Helvetica,sans-serif; line-height: 14px;">{{ s.name }}</td>
	                <td></td><td></td><td></td><td></td><td></td>
	            </tr>
        {% endfor %}
	{% else %}
                <tr>
                    <td style="class:body; font: 11px Arial,Helvetica,sans-serif; line-height: 14px;">None.</td>
                    <td></td><td></td><td></td><td></td><td></td>
                </tr>
    {% endif %}
	        </table>
	   </div>
{% endcache %}
	   <div class="left">
       <div class="footer"></div>
            {% get_comment_count for replay as comment_count %}
	        <h3>Comments ({{ comment_count }}):</h3>
	        {% get_comment_list for replay as comment_list %}
			{% for comment in comment_list %}
				<p><a name="c{{ comment.id }}"></a>
				<b>Comment by "{{ comment.user_name }}" on {{ comment.submit_date }}</b> <a href="{% get_comment_permalink comment %}">(link)</a>: {{ comment.comment }}</p>
			{% endfor %}
	        <a name="afterlastcomment"></a>

            <div class="footer"></div>
	        {% if user.is_authenticated %}
            <h3>Post a comment:</h3>
{% render_comment_form for replay %}
			{% else %}
			<h3>To post a comment you have to <a href="{% url srs.views.login %}">log in</a>.</h3>
            {% endif %}
        </div>
        </div>
{% endblock %}
